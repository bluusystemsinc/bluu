{% extends "alerts/alerts_base.html" %}
{% load i18n crispy_forms_tags grontextual_tags theme_tags alert_tags %}

{% block title %}
    {% trans 'Alerts' %} |
{% endblock %}

{% block breadcrumbs %}
{% bluusites_breadcrumb %}<a href="{% url "site_edit" bluusite.pk %}">{{ bluusite.get_name }}</a> &gt; {% trans "Alerts" %}
{% endblock breadcrumbs %}


{% block page-title %}
    {% trans "Alerts" %}
{% endblock %}


{% block main %}
{{ block.super }}
{% get_uog_perms request.user for bluusite as "bluusite_perms" %}

<div ng-controller="AlertConfController">
{% for device_type in device_types %}
    {% if not forloop.counter|divisibleby:2 %}
    <div class="row-fluid box-row-fluid">
    {% endif %}
        <div class="box-span6 span6">
            {% alerts_for_device_type bluusite device_type %}
        </div>
    {% if forloop.counter|divisibleby:2 or forloop.last %}
    </div>
    {% endif %}
{% endfor %}
</div>
{% endblock %}

{% block javascript %}
  {{ block.super }}
  <script charset="utf-8" type="text/javascript">
  var SITE_ID = {{ bluusite.pk }};
  var USER_ID = {{ user.pk }};
  var SET_ALERT_URL = "{% url "site_alerts:user_alert_config_set" bluusite.pk %}";

  $(document).ready(function() {

    $('.alert_config').change(function(event){

      // get notification parameters for clicked device
      var alert_cfg = $(this).closest('.alert_cfg');
      var device_type_id = alert_cfg.data('device_type_id');
      var alert_id = alert_cft.data('alert_id');

      var notifications = alert_cfg.find('.notification');

      var text = notifications.find('input.text_input');
      var text_val = $(text).is(':checked');
      var email = notifications.find('input.email_input');
      var email_val = $(email).is(':checked');
      
      var durak_val = null;
      var unit_val = null;

      var durak = alert_cfg.find('input.duration');
      var unit = alert_cfg.find('select.unit');
      if (durak || units){
          var durak_val = durak.val();
          var unit_val = unit.val();
      }

      Bluu.set_alert(USER_ID, alert_id, device_type_id, durak_val, unit_val, text_val, email_val)
    });

    $('.device').change(function(event){
      var device_id = $(this).data('device_id');
      var alert_id = $(this).data('alert_id');

      // get notification parameters for clicked device
      var alert_cfg = $(this).closest('.alert_cfg');
      var notifications = alert_cfg.find('.notification');

      var text = notifications.find('input.text_input');
      var text_val = $(text).is(':checked');
      var email = notifications.find('input.email_input');
      var email_val = $(email).is(':checked');
      
      var durak_val = null;
      var unit_val = null;

      var durak = alert_cfg.find('input.duration');
      var unit = alert_cfg.find('select.unit');
      if (durak || units){
          var durak_val = durak.val();
          var unit_val = unit.val();
      }

      Bluu.set_alert(USER_ID, alert_id, device_id, durak_val, unit_val, text_val, email_val)
    }); 
  });
</script>
{% endblock %}


